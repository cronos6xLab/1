<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Juego del Impostor Ultimate</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* PERSONALIZACIÃ“N */
            --bg-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop');
            --primary-color: #8b5cf6;
            --accent-color: #38bdf8;
            --impostor-color: #ef4444;
            --civil-color: #10b981;
            
            /* ESTILOS BASE */
            --glass-bg: rgba(30, 41, 59, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff;
            --font-main: 'Inter', sans-serif;
            --font-title: 'Poppins', sans-serif;
        }

        body {
            font-family: var(--font-main);
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent; /* Mejorar experiencia tÃ¡ctil */
        }

        .container {
            width: 100%;
            max-width: 500px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            position: relative;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { font-family: var(--font-title); margin: 0 0 1rem 0; }
        h1 { font-size: 2.2rem; background: linear-gradient(to right, #fff, var(--accent-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .hidden { display: none !important; }

        /* INPUTS */
        .input-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.85rem; color: var(--accent-color); text-transform: uppercase; letter-spacing: 1px; }

        input, select, textarea {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.4); color: white;
            font-family: inherit; font-size: 1rem; box-sizing: border-box;
            -webkit-appearance: none; /* Para iOS */
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); background: rgba(0,0,0,0.6); }

        /* GRID CATEGORÃAS */
        .categories-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .cat-option input { display: none; }
        .cat-option label {
            display: flex; align-items: center; justify-content: center;
            padding: 12px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; font-weight: 500;
            -webkit-tap-highlight-color: rgba(56, 189, 248, 0.2);
        }
        .cat-option input:checked + label {
            background: var(--primary-color); border-color: var(--primary-color);
            font-weight: bold; transform: scale(1.02);
        }

        /* ÃREA PERSONALIZADA (Oculta por defecto) */
        #custom-area {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 12px;
            margin-top: 10px;
            border: 1px dashed var(--accent-color);
            animation: expand 0.3s ease-out;
        }
        @keyframes expand { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* BOTONES */
        .btn {
            background: linear-gradient(135deg, var(--primary-color), #7c3aed);
            color: white; border: none; padding: 15px; width: 100%;
            border-radius: 50px; font-size: 1.1rem; font-weight: 700;
            cursor: pointer; margin-top: 1rem; box-shadow: 0 5px 20px rgba(124, 58, 237, 0.4);
            -webkit-tap-highlight-color: rgba(139, 92, 246, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: transparent; border: 2px solid rgba(255,255,255,0.2); box-shadow: none; margin-top: 10px; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4); }
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
            width: auto;
            margin: 5px;
        }

        /* LISTA JUGADORES */
        .reveal-item {
            background: rgba(255,255,255,0.05); margin-bottom: 10px;
            padding: 15px; border-radius: 15px; display: flex;
            justify-content: space-between; align-items: center;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
            -webkit-tap-highlight-color: rgba(56, 189, 248, 0.2);
        }
        .reveal-item:hover { background: rgba(255,255,255,0.1); }
        .reveal-item:disabled { opacity: 0.5; cursor: not-allowed; }

        /* MODAL ROL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box;
        }
        .role-card {
            width: 100%; max-width: 400px; padding: 2rem;
            border-radius: 24px; text-align: center;
            animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .is-impostor { background: linear-gradient(135deg, #7f1d1d, #ef4444); border: 2px solid #fca5a5; }
        .is-civil { background: linear-gradient(135deg, #064e3b, #10b981); border: 2px solid #6ee7b7; }
        
        .secret-word-display {
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px;
            font-size: 1.8rem; font-weight: 900; margin: 20px 0;
            border: 1px dashed rgba(255,255,255,0.5); word-break: break-word;
        }

        .timer { font-size: 3.5rem; font-weight: 800; font-variant-numeric: tabular-nums; margin: 15px 0; }
        
        /* SONIDO ALERTA */
        .sound-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* TUTORIAL / AYUDA */
        .help-btn {
            background: rgba(56, 189, 248, 0.2);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: rgba(56, 189, 248, 0.3);
        }
        
        .help-btn:hover, .help-btn:active {
            background: rgba(56, 189, 248, 0.3);
            transform: scale(1.1);
        }
        
        .help-section {
            margin-top: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.5;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .help-section h3 {
            color: var(--accent-color);
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .help-section ul, .help-section ol {
            padding-left: 20px;
            margin: 8px 0;
        }
        
        .help-section li {
            margin-bottom: 5px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1.5rem;
        }
        
        /* INFO ICON - TOOLTIPS MEJORADOS PARA iOS */
        .info-icon-wrapper {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: pointer;
        }
        
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: rgba(56, 189, 248, 0.2);
            border: 1px solid var(--accent-color);
            border-radius: 50%;
            color: var(--accent-color);
            font-size: 0.75rem;
            font-weight: bold;
            font-style: italic;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: rgba(56, 189, 248, 0.3);
            user-select: none;
            -webkit-user-select: none;
        }
        
        .info-icon:hover, .info-icon:active {
            background: rgba(56, 189, 248, 0.3);
            transform: scale(1.1);
        }
        
        .info-icon-tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            color: white;
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            font-size: 0.8rem;
            width: max-content;
            max-width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            white-space: pre-line;
            line-height: 1.4;
            pointer-events: none; /* Evita que interfiera con los toques */
        }
        
        .info-icon-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(30, 41, 59, 0.95) transparent transparent transparent;
        }
        
        /* SOLUCIÃ“N PARA iOS - Mostrar tooltip al tocar */
        .info-icon-wrapper.show-tooltip .info-icon-tooltip,
        .info-icon-tooltip.visible {
            visibility: visible;
            opacity: 1;
        }
        
        /* Para desktop mantener hover */
        @media (hover: hover) and (pointer: fine) {
            .info-icon-wrapper:hover .info-icon-tooltip {
                visibility: visible;
                opacity: 1;
            }
        }
        
        /* Ajustes para labels con info-icon */
        label {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* Mejoras para dispositivos tÃ¡ctiles */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .btn {
                padding: 14px;
                font-size: 1rem;
            }
            
            .info-icon {
                width: 22px;
                height: 22px;
                font-size: 0.8rem;
            }
            
            .info-icon-tooltip {
                font-size: 0.75rem;
                max-width: 200px;
            }
        }
        
        /* Prevenir zoom en inputs en iOS */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px; /* Evita zoom automÃ¡tico en iOS */
            }
        }
    </style>
</head>
<body>

    <div class="container" id="screen-setup">
        <div class="section-header">
            <h1>ğŸ•µï¸â€â™‚ï¸ El Impostor</h1>
            <button class="help-btn" onclick="toggleHelp('setup-help')">?</button>
        </div>
        
        <div id="setup-help" class="help-section hidden">
            <h3>ğŸ“‹ ConfiguraciÃ³n BÃ¡sica</h3>
            <p>AquÃ­ configuras los parÃ¡metros bÃ¡sicos del juego:</p>
            <ul>
                <li><strong>Jugadores:</strong> NÃºmero total de participantes (mÃ­nimo 3)</li>
                <li><strong>Impostores:</strong> CuÃ¡ntos jugadores serÃ¡n impostores (debe ser menor al nÃºmero de jugadores)</li>
                <li><strong>Tiempo:</strong> DuraciÃ³n del debate en minutos</li>
                <li><strong>Sonido de Alerta:</strong> Elige el sonido que sonarÃ¡ cuando termine el tiempo</li>
            </ul>
            <p>ğŸ’¡ <strong>Consejo:</strong> Para grupos grandes (6+ jugadores), considera agregar mÃ¡s impostores.</p>
        </div>
        
        <p style="color: #cbd5e1; margin-bottom: 1.5rem;">ConfiguraciÃ³n Inicial</p>

        <div style="display: flex; gap: 15px;">
            <div class="input-group" style="flex:1">
                <label>
                    Jugadores 
                    <div class="info-icon-wrapper" onclick="toggleTooltip(this)" ontouchstart="toggleTooltip(this)">
                        <span class="info-icon">i</span>
                        <div class="info-icon-tooltip">MÃ­nimo 3 jugadores</div>
                    </div>
                </label>
                <input type="number" id="num-players" value="4" min="3">
            </div>
            <div class="input-group" style="flex:1">
                <label>
                    Impostores 
                    <div class="info-icon-wrapper" onclick="toggleTooltip(this)" ontouchstart="toggleTooltip(this)">
                        <span class="info-icon">i</span>
                        <div class="info-icon-tooltip">Debe haber mÃ¡s jugadores que impostores</div>
                    </div>
                </label>
                <input type="number" id="num-impostors" value="1" min="1">
            </div>
        </div>
        <div class="input-group">
            <label>
                Tiempo (minutos) 
                <div class="info-icon-wrapper" onclick="toggleTooltip(this)" ontouchstart="toggleTooltip(this)">
                    <span class="info-icon">i</span>
                    <div class="info-icon-tooltip">DuraciÃ³n del debate</div>
                </div>
            </label>
            <input type="number" id="game-time" value="5" min="1">
        </div>
        
        <div class="input-group">
            <label>
                Sonido de Alerta â° 
                <div class="info-icon-wrapper" onclick="toggleTooltip(this)" ontouchstart="toggleTooltip(this)">
                    <span class="info-icon">i</span>
                    <div class="info-icon-tooltip">SonarÃ¡ cuando termine el tiempo o en los Ãºltimos 3 segundos</div>
                </div>
            </label>
            <select id="alarm-sound">
                <option value="none">Sin sonido</option>
                <option value="beep">Beep ClÃ¡sico</option>
                <option value="bell">Campana</option>
                <option value="digital">Digital</option>
                <option value="alarm">Alarma de Emergencia</option>
                <option value="chime">Campanilla</option>
                <option value="buzzer">Buzzer</option>
            </select>
            <div class="sound-preview">
                <span id="selected-sound-name">Sin sonido</span>
                <button class="btn btn-small" onclick="testAlarmSound()">Probar Sonido</button>
            </div>
        </div>

        <button class="btn" onclick="goToCategories(true)">Continuar ğŸ‘‰</button>
    </div>

    <div class="container hidden" id="screen-categories">
        <div class="section-header">
            <h2>ğŸ“‚ Elige Temas</h2>
            <button class="help-btn" onclick="toggleHelp('categories-help')">?</button>
        </div>
        
        <div id="categories-help" class="help-section hidden">
            <h3>ğŸ¯ SelecciÃ³n de CategorÃ­as</h3>
            <p>Selecciona una o varias categorÃ­as para generar la palabra secreta:</p>
            <ul>
                <li><strong>CategorÃ­as predefinidas:</strong> Contienen listas de palabras temÃ¡ticas</li>
                <li><strong>Personalizado:</strong> Escribe tus propias palabras separadas por comas</li>
            </ul>
            <p>ğŸ’¡ <strong>Consejo:</strong> Cuantas mÃ¡s categorÃ­as selecciones, mÃ¡s variadas serÃ¡n las palabras.</p>
            <p>âš ï¸ <strong>Nota:</strong> Al menos una categorÃ­a debe estar seleccionada para continuar.</p>
        </div>
        
        <p style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 1rem;">Selecciona uno o varios.</p>

        <div class="categories-grid">
            <div class="cat-option"><input type="checkbox" id="cat-Variado" checked><label for="cat-Variado">ğŸ² Variado</label></div>
            <div class="cat-option"><input type="checkbox" id="cat-Lugares"><label for="cat-Lugares">âœˆï¸ Lugares</label></div>
            <div class="cat-option"><input type="checkbox" id="cat-Comidas"><label for="cat-Comidas">ğŸ• Comidas</label></div>
            <div class="cat-option"><input type="checkbox" id="cat-Animales"><label for="cat-Animales">ğŸ¦ Animales</label></div>
            <div class="cat-option"><input type="checkbox" id="cat-Peliculas"><label for="cat-Peliculas">ğŸ¬ PelÃ­culas</label></div>
            <div class="cat-option"><input type="checkbox" id="cat-Deportes"><label for="cat-Deportes">âš½ Deportes</label></div>
            <div class="cat-option"><input type="checkbox" id="cat-Anime"><label for="cat-Anime">ğŸŒ Anime</label></div>
            <div class="cat-option"><input type="checkbox" id="cat-Videojuegos"><label for="cat-Videojuegos">ğŸ® Juegos</label></div>
            
            <div class="cat-option" style="grid-column: span 2;">
                <input type="checkbox" id="cat-Personalizado" onchange="toggleCustomArea()">
                <label for="cat-Personalizado">âœï¸ Personalizado (Escribir mis palabras)</label>
            </div>
        </div>

        <div id="custom-area" class="hidden">
            <label>
                Tus palabras (separadas por coma): 
                <div class="info-icon-wrapper" onclick="toggleTooltip(this)" ontouchstart="toggleTooltip(this)">
                    <span class="info-icon">i</span>
                    <div class="info-icon-tooltip">Ejemplo: Casa, Perro, Pizza, PelÃ­cula</div>
                </div>
            </label>
            <textarea id="custom-words" rows="3" placeholder="Ej: Mi Casa, La Oficina, El Jefe, Mi Perro..."></textarea>
        </div>

        <button class="btn" onclick="goToNames()">Siguiente</button>
        <button class="btn btn-secondary" onclick="fullReset()">ğŸ”™ MenÃº Principal</button>
    </div>

    <div class="container hidden" id="screen-names">
        <div class="section-header">
            <h2>ğŸ“ Jugadores</h2>
            <button class="help-btn" onclick="toggleHelp('names-help')">?</button>
        </div>
        
        <div id="names-help" class="help-section hidden">
            <h3>ğŸ‘¥ AsignaciÃ³n de Nombres</h3>
            <p>Asigna un nombre Ãºnico a cada jugador para identificarlos durante el juego:</p>
            <ul>
                <li>Puedes usar nombres reales o apodos</li>
                <li>Los nombres se guardan automÃ¡ticamente mientras juegas</li>
                <li>Si cambias el nÃºmero de jugadores, se reiniciarÃ¡n los nombres</li>
            </ul>
            <p>ğŸ’¡ <strong>Consejo:</strong> Usa nombres distintivos para evitar confusiones durante el debate.</p>
        </div>
        
        <p style="font-size: 0.8rem; opacity: 0.7;">Asigna un nombre a cada jugador</p>
        
        <div id="names-list" style="max-height: 50vh; overflow-y: auto; margin-bottom: 20px; padding-right: 5px;">
            </div>

        <button class="btn" onclick="assignRoles()">Repartir Roles ğŸ²</button>
        <button class="btn btn-secondary" onclick="showScreen('screen-categories')">AtrÃ¡s</button>
    </div>

    <div class="container hidden" id="screen-reveal">
        <div class="section-header">
            <h2>ğŸ¤« Identidad Secreta</h2>
            <button class="help-btn" onclick="toggleHelp('reveal-help')">?</button>
        </div>
        
        <div id="reveal-help" class="help-section hidden">
            <h3>ğŸ•µï¸â€â™‚ï¸ RevelaciÃ³n de Roles</h3>
            <p>En esta fase, cada jugador verÃ¡ su rol en privado:</p>
            <ol>
                <li><strong>Civiles:</strong> VerÃ¡n la palabra secreta y deben hacer preguntas sobre ella</li>
                <li><strong>Impostores:</strong> NO verÃ¡n la palabra y deben engaÃ±ar a los demÃ¡s</li>
            </ol>
            <p><strong>Instrucciones:</strong></p>
            <ul>
                <li>Pasa el dispositivo a cada jugador en orden</li>
                <li>Cada jugador presiona su nombre para ver su rol</li>
                <li>No reveles tu rol a los demÃ¡s jugadores</li>
                <li>Cuando todos hayan visto su rol, comienza el debate</li>
            </ul>
            <p>âš ï¸ <strong>Importante:</strong> Los impostores deben fingir que conocen la palabra.</p>
        </div>
        
        <p style="color: var(--accent-color);">Pasa el dispositivo al jugador indicado.</p>
        <div id="reveal-list"></div>
        <button id="btn-begin-debate" class="btn hidden" onclick="startDebate()">ğŸ”¥ Empezar Juego</button>
    </div>

    <div class="container hidden" id="screen-game">
        <div class="section-header">
            <h2>â³ Debate</h2>
            <button class="help-btn" onclick="toggleHelp('game-help')">?</button>
        </div>
        
        <div id="game-help" class="help-section hidden">
            <h3>ğŸ—£ï¸ CÃ³mo Jugar</h3>
            <p><strong>Objetivo del juego:</strong></p>
            <ul>
                <li><strong>Civiles:</strong> Descubrir quiÃ©nes son los impostores antes de que se acabe el tiempo</li>
                <li><strong>Impostores:</strong> EngaÃ±ar a los civiles sin ser descubiertos</li>
            </ul>
            
            <p><strong>DinÃ¡mica del debate:</strong></p>
            <ol>
                <li>El jugador indicado comienza haciendo una pregunta sobre la palabra secreta</li>
                <li>ContinÃºa la discusiÃ³n en sentido horario</li>
                <li>Los civiles deben hacer preguntas especÃ­ficas sobre la palabra</li>
                <li>Los impostores deben responder sin revelar que no conocen la palabra</li>
                <li>Cuando el tiempo termine, se vota quiÃ©nes son los impostores</li>
            </ol>
            
            <p>ğŸ’¡ <strong>Consejos para civiles:</strong></p>
            <ul>
                <li>Haz preguntas especÃ­ficas, no generales</li>
                <li>Observa las reacciones y contradicciones</li>
                <li>Colabora con otros civiles para descubrir impostores</li>
            </ul>
            
            <p>ğŸ’¡ <strong>Consejos para impostores:</strong></p>
            <ul>
                <li>Escucha atentamente las respuestas de los civiles</li>
                <li>Da respuestas vagas pero plausibles</li>
                <li>Acusa a otros jugadores para desviar sospechas</li>
            </ul>
        </div>
        
        <div id="timer-display" class="timer">00:00</div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <p style="margin:0; font-size:0.9rem; color:#cbd5e1">Empieza preguntando:</p>
            <strong id="starter-player" style="font-size:1.4rem; color:var(--accent-color); display:block; margin-top:5px;">---</strong>
        </div>

        <button class="btn" id="btn-pause" onclick="togglePause()">Pausar</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-secondary" onclick="softReset()">ğŸ”„ Nueva Partida</button>
            <button class="btn btn-secondary btn-danger" onclick="fullReset()">ğŸ  MenÃº Principal</button>
        </div>
    </div>

    <div id="role-modal" class="modal-overlay hidden"></div>

    <script>
        // ================= DATOS =================
        const database = {
            "Variado": ["Playa", "Escuela", "Hospital", "Pizza", "Perro", "Titanic", "FÃºtbol", "Mario Bros", "Goku", "Batman", "Cine", "AviÃ³n"],
            "Lugares": [â€œPlayaâ€, â€œMontaÃ±aâ€, â€œBosqueâ€, â€œDesiertoâ€, â€œCiudadâ€, â€œPuebloâ€, â€œIslaâ€, â€œValleâ€, â€œRÃ­oâ€, â€œLagoâ€, â€œCascadaâ€, â€œCaÃ±Ã³nâ€, â€œGlaciarâ€, â€œSelvaâ€, â€œSabanaâ€, â€œTemploâ€, â€œCatedralâ€, â€œMezquitaâ€, â€œSinagogaâ€, â€œCastilloâ€, â€œPalacioâ€, â€œMercadoâ€, â€œPlazaâ€, â€œParqueâ€, â€œMuseoâ€, â€œBibliotecaâ€, â€œUniversidadâ€, â€œEscuelaâ€, â€œHospitalâ€, â€œEstadioâ€, â€œAeropuertoâ€, â€œEstaciÃ³nâ€, â€œPuertoâ€, â€œZoolÃ³gicoâ€, â€œAcuarioâ€, â€œParque de atraccionesâ€, â€œRestauranteâ€, â€œCafÃ©â€, â€œHotelâ€, â€œHostalâ€, â€œRascacielosâ€, â€œBarrio antiguoâ€, â€œPuerto pesqueroâ€, â€œMiradorâ€, â€œFaroâ€, â€œGranjaâ€, â€œViÃ±edoâ€, â€œInvernaderoâ€, â€œMonasterioâ€, â€œRuinasâ€, â€œPlaza centralâ€, â€œCentro comercialâ€, â€œOficinaâ€, â€œGimnasioâ€, â€œSpaâ€, â€œBalnearioâ€, â€œCuevaâ€, â€œVolcÃ¡nâ€, â€œCruceroâ€, â€œParque nacionalâ€],
            "Comidas": [â€œPizzaâ€, â€œHamburguesaâ€, â€œTacoâ€, â€œBurritoâ€, â€œQuesadillaâ€, â€œEnchiladasâ€, â€œPozoleâ€, â€œTamalesâ€, â€œChilaquilesâ€, â€œMoleâ€, â€œSushiâ€, â€œRamenâ€, â€œTempuraâ€, â€œCurryâ€, â€œPad thaiâ€, â€œArroz fritoâ€, â€œPaellaâ€, â€œTortilla espaÃ±olaâ€, â€œGazpachoâ€, â€œPastaâ€, â€œLasaÃ±aâ€, â€œSpaghettiâ€, â€œRisottoâ€, â€œCevicheâ€, â€œArepaâ€, â€œEmpanadaâ€, â€œFeijoadaâ€, â€œAsadoâ€, â€œCordero al hornoâ€, â€œPollo rostizadoâ€, â€œFileteâ€, â€œTarta de manzanaâ€, â€œHeladoâ€, â€œPastel de chocolateâ€, â€œBrownieâ€, â€œGalletasâ€, â€œCroissantâ€, â€œBagelâ€, â€œSandwichâ€, â€œHot dogâ€, â€œEnsalada CÃ©sarâ€, â€œEnsalada griegaâ€, â€œSopa de tomateâ€, â€œCaldo de polloâ€, â€œPhoâ€, â€œDim sumâ€, â€œGyozaâ€, â€œKebabâ€, â€œFalafelâ€, â€œHummusâ€, â€œTabulÃ©â€, â€œGuacamoleâ€, â€œNachosâ€, â€œAlitas picantesâ€, â€œPan dulceâ€, â€œChurrosâ€, â€œFlanâ€, â€œGelatinaâ€, â€œYogur griegoâ€, â€œSmoothieâ€],
            "Animales": [â€œPerroâ€, â€œGatoâ€, â€œLoboâ€, â€œZorroâ€, â€œOsoâ€, â€œLeÃ³nâ€, â€œTigreâ€, â€œJaguarâ€, â€œPanteraâ€, â€œElefanteâ€, â€œJirafaâ€, â€œCebraâ€, â€œRinoceronteâ€, â€œHipopÃ³tamoâ€, â€œCanguroâ€, â€œKoalaâ€, â€œOrnitorrincoâ€, â€œDelfÃ­nâ€, â€œBallenaâ€, â€œTiburÃ³nâ€, â€œFocaâ€, â€œPingÃ¼inoâ€, â€œÃguilaâ€, â€œHalcÃ³nâ€, â€œBÃºhoâ€, â€œLoroâ€, â€œColibrÃ­â€, â€œFlamencoâ€, â€œPatoâ€, â€œGansoâ€, â€œGallinaâ€, â€œGalloâ€, â€œVacaâ€, â€œToroâ€, â€œCerdoâ€, â€œOvejaâ€, â€œCabraâ€, â€œCaballoâ€, â€œBurroâ€, â€œCamelloâ€, â€œLlamaâ€, â€œAlpacaâ€, â€œConejoâ€, â€œHÃ¡msterâ€, â€œRatÃ³nâ€, â€œRataâ€, â€œMapacheâ€, â€œNutriaâ€, â€œCastorâ€, â€œIguanaâ€, â€œSerpienteâ€, â€œCocodriloâ€, â€œRanaâ€, â€œSapoâ€, â€œMariposaâ€, â€œAbejaâ€, â€œHormigaâ€, â€œAraÃ±aâ€, â€œEscorpiÃ³nâ€, â€œMedusaâ€],
            "Peliculas": [â€œTitanicâ€, â€œAvatarâ€, â€œVengadores: Endgameâ€, â€œAvatar 2â€, â€œStar Warsâ€, â€œTitanicâ€, â€œEl Rey LeÃ³nâ€, â€œFrozen 2â€, â€œSpider-Manâ€, â€œJurassic Worldâ€, â€œHarry Potterâ€, â€œEl SeÃ±or de los Anillosâ€, â€œToy Storyâ€, â€œLos IncreÃ­blesâ€, â€œFast & Furiousâ€, â€œDunaâ€, â€œTop Gunâ€, â€œBlack Pantherâ€, â€œIron Manâ€, â€œCaptain Americaâ€, â€œThorâ€, â€œHulkâ€, â€œJack Sparrowâ€, â€œDarth Vaderâ€, â€œYodaâ€, â€œLuke Skywalkerâ€, â€œHan Soloâ€, â€œPrincesa Leiaâ€, â€œHarry Potterâ€, â€œHermione Grangerâ€, â€œRon Weasleyâ€, â€œDumbledoreâ€, â€œVoldemortâ€, â€œIndiana Jonesâ€, â€œJames Bondâ€, â€œBatmanâ€, â€œJokerâ€, â€œSupermanâ€, â€œWonder Womanâ€, â€œSpider-Manâ€, â€œHomer Simpsonâ€, â€œBart Simpsonâ€, â€œShrekâ€, â€œFionaâ€, â€œDonkeyâ€, â€œElsaâ€, â€œAnnaâ€, â€œSimbaâ€, â€œMufasaâ€, â€œBuzz Lightyearâ€, â€œWoodyâ€, â€œNeoâ€, â€œTrinityâ€, â€œMorpheusâ€, â€œRocky Balboaâ€, â€œForrest Gumpâ€, â€œWilly Wonkaâ€, â€œEllen Ripleyâ€, â€œHannibal Lecterâ€, â€œTyler Durdenâ€, â€œGollumâ€, â€œJohn Wickâ€, â€œDeadpoolâ€],
            "Deportes": [â€œFÃºtbolâ€, â€œBÃ¡squetbolâ€, â€œBÃ©isbolâ€, â€œTenisâ€, â€œVoleibolâ€, â€œNataciÃ³nâ€, â€œAtletismoâ€, â€œBoxeoâ€, â€œCiclismoâ€, â€œGimnasiaâ€, â€œRugbyâ€, â€œGolfâ€, â€œEsgrimaâ€, â€œArquerÃ­aâ€, â€œSurfâ€, â€œSkateâ€, â€œSnowboardâ€, â€œEscaladaâ€, â€œSenderismoâ€, â€œMaratÃ³nâ€, â€œTriatlÃ³nâ€, â€œTaekwondoâ€, â€œJudoâ€, â€œKarateâ€, â€œMMAâ€, â€œLucha libreâ€, â€œHalterofiliaâ€, â€œRemoâ€, â€œCanotajeâ€, â€œParkourâ€, â€œPatinaje artÃ­sticoâ€, â€œPatinaje en lÃ­neaâ€, â€œMotocrossâ€, â€œRallyâ€, â€œAutomovilismoâ€, â€œFÃºtbol americanoâ€, â€œFÃºtbol salaâ€, â€œHandballâ€, â€œWaterpoloâ€, â€œPoloâ€, â€œCrÃ­quetâ€, â€œHockey hieloâ€, â€œHockey cÃ©spedâ€, â€œSoftbolâ€, â€œBalonmano playaâ€, â€œEsquÃ­ alpinoâ€, â€œEsquÃ­ de fondoâ€, â€œSnorkelâ€, â€œBuceoâ€, â€œPesca deportivaâ€, â€œEquitaciÃ³nâ€, â€œAjedrezâ€, â€œE-sportsâ€, â€œPÃ¡delâ€, â€œFrontÃ³nâ€, â€œSquashâ€, â€œCrossFitâ€, â€œCalisteniaâ€, â€œStreet workoutâ€, â€œYoga deportivoâ€],
            "Anime": [â€œDragon Ballâ€, â€œNarutoâ€, â€œOne Pieceâ€, â€œDemon Slayerâ€, â€œAttack on Titanâ€, â€œDeath Noteâ€, â€œFullmetal Alchemistâ€, â€œOne Punch Manâ€, â€œSword Art Onlineâ€, â€œMy Hero Academiaâ€, â€œJujutsu Kaisenâ€, â€œTokyo Ghoulâ€, â€œHunter x Hunterâ€, â€œSteins;Gateâ€, â€œCode Geassâ€, â€œRe:Zeroâ€, â€œNo Game No Lifeâ€, â€œGintamaâ€, â€œYu-Gi-Oh!â€, â€œInuyashaâ€, â€œFrierenâ€, â€œChainsaw Manâ€, â€œSolo Levelingâ€, â€œDandadanâ€, â€œGokuâ€, â€œVegetaâ€, â€œGohanâ€, â€œNarutoâ€, â€œSasukeâ€, â€œKakashiâ€, â€œLuffyâ€, â€œZoroâ€, â€œTanjiroâ€, â€œNezukoâ€, â€œErenâ€, â€œMikasaâ€, â€œLeviâ€, â€œLightâ€, â€œLâ€, â€œSaitamaâ€, â€œGenosâ€, â€œKiritoâ€, â€œAsunaâ€, â€œDekuâ€, â€œBakugoâ€, â€œTodorokiâ€, â€œGojoâ€, â€œItadoriâ€, â€œMegumiâ€, â€œNobaraâ€, â€œKanekiâ€, â€œToukaâ€, â€œGonâ€, â€œKilluaâ€, â€œHisokaâ€, â€œLelouchâ€, â€œSuzakuâ€, â€œC.C.â€, â€œRemâ€, â€œEmiliaâ€],
            "Videojuegos": [â€œMinecraftâ€, â€œGrand Theft Auto Vâ€, â€œTetrisâ€, â€œWii Sportsâ€, â€œPUBGâ€, â€œMario Kart 8â€, â€œSkyrimâ€, â€œSuper Mario Brosâ€, â€œRed Dead Redemption 2â€, â€œThe Witcher 3â€, â€œOverwatchâ€, â€œPokÃ©mon Rojoâ€, â€œTerrariaâ€, â€œWii Fitâ€, â€œAnimal Crossingâ€, â€œPac-Manâ€, â€œMario Kart Wiiâ€, â€œZelda Breath of the Wildâ€, â€œSuper Smash Brosâ€, â€œNew Super Mario Brosâ€, â€œMarioâ€, â€œLinkâ€, â€œMaster Chiefâ€, â€œKratosâ€, â€œLara Croftâ€, â€œSonicâ€, â€œPac-Manâ€, â€œDonkey Kongâ€, â€œKirbyâ€, â€œPikachuâ€, â€œGeraltâ€, â€œArthur Morganâ€, â€œCloud Strifeâ€, â€œSolid Snakeâ€, â€œSamus Aranâ€, â€œDuke Nukemâ€, â€œDoomguyâ€, â€œG-Manâ€, â€œGordon Freemanâ€, â€œCrash Bandicootâ€, â€œSpyroâ€, â€œRatchetâ€, â€œClankâ€, â€œJakâ€, â€œDaxterâ€, â€œSackboyâ€, â€œNathan Drakeâ€, â€œJoelâ€, â€œEllieâ€, â€œAloyâ€, â€œKenaâ€, â€œAbzÃ»â€, â€œTracerâ€, â€œReinhardtâ€, â€œGTA Vâ€, â€œTrevor Philipsâ€, â€œFranklinâ€, â€œMichaelâ€, â€œNiko Bellicâ€, â€œCJâ€]
        };

        // Estado Global
        let savedPlayerNames = []; // AquÃ­ guardamos los nombres entre partidas
        let gameConfig = { players: 4, impostors: 1, time: 5 };
        let gameData = {
            impostorIndices: [],
            secretWord: "",
            timeLeft: 0,
            timerInterval: null,
            paused: false,
            alarmSound: "none"
        };
        let rolesViewed = 0;
        let audioContext = null;
        let helpOpen = null; // Para controlar quÃ© ayuda estÃ¡ abierta
        let activeTooltip = null; // Para controlar quÃ© tooltip estÃ¡ activo

        // ================= FUNCIONES PARA TOOLTIPS EN iOS =================
        function toggleTooltip(element) {
            // Cerrar tooltip activo si hay uno diferente
            if (activeTooltip && activeTooltip !== element) {
                activeTooltip.classList.remove('show-tooltip');
            }
            
            // Alternar el tooltip actual
            element.classList.toggle('show-tooltip');
            
            // Actualizar el tooltip activo
            if (element.classList.contains('show-tooltip')) {
                activeTooltip = element;
            } else {
                activeTooltip = null;
            }
            
            // Cerrar tooltip despuÃ©s de 3 segundos en mÃ³viles
            if (window.innerWidth <= 768) {
                setTimeout(() => {
                    if (element.classList.contains('show-tooltip')) {
                        element.classList.remove('show-tooltip');
                        activeTooltip = null;
                    }
                }, 3000);
            }
            
            // Prevenir el comportamiento por defecto
            return false;
        }

        // Cerrar tooltips al tocar fuera
        function closeAllTooltips(event) {
            if (activeTooltip && !activeTooltip.contains(event.target)) {
                activeTooltip.classList.remove('show-tooltip');
                activeTooltip = null;
            }
        }

        // ================= FUNCIONES DE AYUDA =================
        function toggleHelp(helpId) {
            const helpElement = document.getElementById(helpId);
            
            // Si ya hay una ayuda abierta diferente, la cerramos
            if (helpOpen && helpOpen !== helpElement) {
                helpOpen.classList.add('hidden');
            }
            
            // Alternamos la visibilidad de la ayuda solicitada
            helpElement.classList.toggle('hidden');
            
            // Actualizamos quÃ© ayuda estÃ¡ abierta
            if (helpElement.classList.contains('hidden')) {
                helpOpen = null;
            } else {
                helpOpen = helpElement;
                
                // Desplazar suavemente a la ayuda si es necesario
                helpElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Cerramos todas las ayudas al cambiar de pantalla
        function closeAllHelp() {
            if (helpOpen) {
                helpOpen.classList.add('hidden');
                helpOpen = null;
            }
        }

        // ================= SONIDOS =================
        const alarmSounds = {
            none: { name: "Sin sonido", play: () => {} },
            beep: { 
                name: "Beep ClÃ¡sico",
                play: () => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                }
            },
            bell: {
                name: "Campana",
                play: () => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 600;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 1);
                }
            },
            digital: {
                name: "Digital",
                play: () => {
                    for(let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = 1000;
                            oscillator.type = 'square';
                            
                            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                            
                            oscillator.start(audioContext.currentTime);
                            oscillator.stop(audioContext.currentTime + 0.1);
                        }, i * 200);
                    }
                }
            },
            alarm: {
                name: "Alarma de Emergencia",
                play: () => {
                    const oscillator1 = audioContext.createOscillator();
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator1.connect(gainNode);
                    oscillator2.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator1.frequency.value = 800;
                    oscillator2.frequency.value = 600;
                    oscillator1.type = 'sawtooth';
                    oscillator2.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    
                    oscillator1.start(audioContext.currentTime);
                    oscillator2.start(audioContext.currentTime);
                    oscillator1.stop(audioContext.currentTime + 1);
                    oscillator2.stop(audioContext.currentTime + 1);
                }
            },
            chime: {
                name: "Campanilla",
                play: () => {
                    const frequencies = [523.25, 659.25, 783.99]; // Do, Mi, Sol
                    
                    frequencies.forEach((freq, i) => {
                        setTimeout(() => {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = freq;
                            oscillator.type = 'triangle';
                            
                            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                            
                            oscillator.start(audioContext.currentTime);
                            oscillator.stop(audioContext.currentTime + 0.3);
                        }, i * 150);
                    });
                }
            },
            buzzer: {
                name: "Buzzer",
                play: () => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 200;
                    oscillator.type = 'square';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.8);
                }
            }
        };

        // FunciÃ³n para inicializar AudioContext
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // FunciÃ³n para probar el sonido de alarma
        function testAlarmSound() {
            initAudioContext();
            const soundSelect = document.getElementById('alarm-sound');
            const soundType = soundSelect.value;
            
            if (soundType !== 'none') {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                alarmSounds[soundType].play();
            }
        }

        // FunciÃ³n para reproducir la alarma del temporizador
        function playAlarmSound() {
            if (gameData.alarmSound !== 'none') {
                initAudioContext();
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                alarmSounds[gameData.alarmSound].play();
            }
        }

        // Actualizar nombre del sonido seleccionado
        function updateSelectedSoundName() {
            const soundSelect = document.getElementById('alarm-sound');
            const soundType = soundSelect.value;
            document.getElementById('selected-sound-name').textContent = alarmSounds[soundType].name;
        }

        // ================= NAVEGACIÃ“N =================
        
        function showScreen(id) {
            closeAllHelp(); // Cerramos todas las ayudas al cambiar de pantalla
            // Cerramos tooltips activos
            if (activeTooltip) {
                activeTooltip.classList.remove('show-tooltip');
                activeTooltip = null;
            }
            document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // Toggle para mostrar/ocultar input personalizado
        function toggleCustomArea() {
            const checkbox = document.getElementById('cat-Personalizado');
            const area = document.getElementById('custom-area');
            if(checkbox.checked) area.classList.remove('hidden');
            else area.classList.add('hidden');
        }

        // Ir a CategorÃ­as (Guardando config inicial)
        function goToCategories(fromSetup = false) {
            if (fromSetup) {
                const p = parseInt(document.getElementById('num-players').value);
                const i = parseInt(document.getElementById('num-impostors').value);
                const t = parseInt(document.getElementById('game-time').value);
                const soundType = document.getElementById('alarm-sound').value;

                if (p < 3) return alert("MÃ­nimo 3 jugadores.");
                if (i >= p) return alert("Debe haber mÃ¡s jugadores que impostores.");

                // Si cambiamos el nÃºmero de jugadores, reseteamos los nombres guardados
                if (p !== gameConfig.players) {
                    savedPlayerNames = new Array(p).fill("");
                } else if (savedPlayerNames.length === 0) {
                    savedPlayerNames = new Array(p).fill("");
                }

                gameConfig = { players: p, impostors: i, time: t };
                gameData.alarmSound = soundType;
            }
            showScreen('screen-categories');
        }

        // Ir a Nombres
        function goToNames() {
            // Validar selecciÃ³n
            const checkboxes = document.querySelectorAll('.categories-grid input:checked');
            const customText = document.getElementById('custom-words').value.trim();
            const customCheck = document.getElementById('cat-Personalizado').checked;

            if (checkboxes.length === 0 && (!customCheck || customText === "")) {
                return alert("Selecciona al menos una categorÃ­a o escribe palabras personalizadas.");
            }

            // Generar inputs preservando valores guardados
            const container = document.getElementById('names-list');
            container.innerHTML = "";
            
            for(let i=0; i < gameConfig.players; i++) {
                // Usar nombre guardado o default
                const val = savedPlayerNames[i] || `Jugador ${i+1}`;
                container.innerHTML += `
                <div class="input-group" style="margin-bottom:10px;">
                    <input type="text" id="pname-${i}" placeholder="Nombre Jugador ${i+1}" value="${val}" onchange="saveName(${i}, this.value)">
                </div>`;
            }
            // Actualizar array por si acaso venÃ­an defaults
            saveAllNamesCurrent();
            
            showScreen('screen-names');
        }

        // FunciÃ³n auxiliar para guardar nombres en tiempo real
        function saveName(index, value) {
            savedPlayerNames[index] = value;
        }

        function saveAllNamesCurrent() {
            for(let i=0; i < gameConfig.players; i++) {
                const el = document.getElementById(`pname-${i}`);
                if(el) savedPlayerNames[i] = el.value.trim() || `Jugador ${i+1}`;
            }
        }

        // ================= LÃ“GICA DE PARTIDA =================

        function assignRoles() {
            saveAllNamesCurrent(); // Asegurar que tenemos los Ãºltimos nombres
            
            // 1. Elegir Palabra
            let wordPool = [];
            document.querySelectorAll('.categories-grid input:checked').forEach(cb => {
                const key = cb.id.replace('cat-', '');
                if (key !== "Personalizado" && database[key]) {
                    wordPool = wordPool.concat(database[key]);
                }
            });
            
            if (document.getElementById('cat-Personalizado').checked) {
                const txt = document.getElementById('custom-words').value;
                const customs = txt.split(',').map(w => w.trim()).filter(w => w.length > 0);
                wordPool = wordPool.concat(customs);
            }

            if (wordPool.length === 0) return alert("Error: No hay palabras disponibles.");
            gameData.secretWord = wordPool[Math.floor(Math.random() * wordPool.length)];

            // 2. Elegir Impostores
            gameData.impostorIndices = [];
            while(gameData.impostorIndices.length < gameConfig.impostors) {
                let r = Math.floor(Math.random() * gameConfig.players);
                if(!gameData.impostorIndices.includes(r)) gameData.impostorIndices.push(r);
            }

            // 3. UI RevelaciÃ³n
            rolesViewed = 0;
            const list = document.getElementById('reveal-list');
            list.innerHTML = "";
            
            savedPlayerNames.forEach((name, idx) => {
                const btn = document.createElement('button');
                btn.className = "reveal-item";
                btn.id = `btn-rev-${idx}`;
                btn.innerHTML = `<span>ğŸ‘¤ ${name}</span> <span>ğŸ‘ï¸ Ver Rol</span>`;
                btn.onclick = () => showRoleModal(idx);
                list.appendChild(btn);
            });

            document.getElementById('btn-begin-debate').classList.add('hidden');
            showScreen('screen-reveal');
        }

        function showRoleModal(idx) {
            const modal = document.getElementById('role-modal');
            const isImpostor = gameData.impostorIndices.includes(idx);
            
            let content = "";
            if(isImpostor) {
                content = `
                <div class="role-card is-impostor">
                    <h1 style="font-size:2rem;">ğŸ¤« ERES EL IMPOSTOR</h1>
                    <div class="secret-word-display">???</div>
                    <p>No conoces la palabra secreta. Finge que sÃ­ la sabes y responde como si la conocieras.</p>
                    <p style="font-size:0.9rem; margin-top:15px;"><strong>Estrategia:</strong> Escucha a los civiles y da respuestas vagas pero creÃ­bles.</p>
                    <button class="btn" onclick="hideRoleModal(${idx})">Entendido</button>
                </div>`;
            } else {
                content = `
                <div class="role-card is-civil">
                    <h1 style="font-size:2rem;">ğŸ˜‡ ERES CIVIL</h1>
                    <p>La palabra secreta es:</p>
                    <div class="secret-word-display">${gameData.secretWord}</div>
                    <p>Debes hacer preguntas sobre esta palabra sin revelarla directamente.</p>
                    <p style="font-size:0.9rem; margin-top:15px;"><strong>Estrategia:</strong> Haz preguntas especÃ­ficas para descubrir a los impostores.</p>
                    <button class="btn" onclick="hideRoleModal(${idx})">Entendido</button>
                </div>`;
            }
            modal.innerHTML = content;
            modal.classList.remove('hidden');
        }

        function hideRoleModal(idx) {
            document.getElementById('role-modal').classList.add('hidden');
            const btn = document.getElementById(`btn-rev-${idx}`);
            btn.disabled = true;
            btn.innerHTML = `<span>ğŸ‘¤ ${savedPlayerNames[idx]}</span> <span>âœ… Rol Visto</span>`;
            
            rolesViewed++;
            if(rolesViewed >= gameConfig.players) {
                document.getElementById('btn-begin-debate').classList.remove('hidden');
            }
        }

        function startDebate() {
            showScreen('screen-game');
            
            // LÃ“GICA JUGADOR INICIAL (NO IMPOSTOR)
            // Filtramos los Ã­ndices que NO son impostores
            const civilians = [];
            for(let i=0; i < gameConfig.players; i++) {
                if(!gameData.impostorIndices.includes(i)) {
                    civilians.push(i);
                }
            }
            // Elegimos uno al azar de la lista de civiles
            const starterIndex = civilians[Math.floor(Math.random() * civilians.length)];
            document.getElementById('starter-player').innerText = savedPlayerNames[starterIndex];

            // Timer
            gameData.timeLeft = gameConfig.time * 60;
            gameData.paused = false;
            updateTimer();
            if(gameData.timerInterval) clearInterval(gameData.timerInterval);
            gameData.timerInterval = setInterval(() => {
                if(!gameData.paused) {
                    gameData.timeLeft--;
                    updateTimer();
                    if(gameData.timeLeft <= 0) {
                        clearInterval(gameData.timerInterval);
                        playAlarmSound(); // Reproducir sonido de alarma
                        alert("Â¡Tiempo terminado!\n\nEs hora de votar. Discutan y decidan quiÃ©nes creen que son los impostores.");
                    } else if (gameData.timeLeft <= 3) {
                        // Reproducir sonido para los Ãºltimos 3 segundos
                        playAlarmSound();
                    }
                }
            }, 1000);
        }

        function updateTimer() {
            const m = Math.floor(gameData.timeLeft / 60).toString().padStart(2,'0');
            const s = (gameData.timeLeft % 60).toString().padStart(2,'0');
            const disp = document.getElementById('timer-display');
            disp.innerText = `${m}:${s}`;
            if(gameData.timeLeft < 10) disp.style.color = "#ef4444";
            else disp.style.color = "white";
        }

        function togglePause() {
            gameData.paused = !gameData.paused;
            document.getElementById('btn-pause').innerText = gameData.paused ? "Reanudar" : "Pausar";
        }

        // ================= RESETEO =================

        // NUEVA PARTIDA: Mantiene nombres, vuelve a categorÃ­as
        function softReset() {
            if(confirm("Â¿Terminar partida actual y jugar otra con los mismos jugadores?")) {
                clearInterval(gameData.timerInterval);
                showScreen('screen-categories');
            }
        }

        // MENÃš PRINCIPAL: Borra todo
        function fullReset() {
            if(confirm("Â¿Volver al menÃº principal? Se borrarÃ¡n los nombres.")) {
                clearInterval(gameData.timerInterval);
                location.reload(); 
            }
        }

        // ================= INICIALIZACIÃ“N =================
        document.addEventListener('DOMContentLoaded', function() {
            // Actualizar nombre del sonido al cargar
            updateSelectedSoundName();
            
            // Actualizar cuando cambie el selector de sonido
            document.getElementById('alarm-sound').addEventListener('change', updateSelectedSoundName);
            
            // Cerrar tooltips al hacer clic/tocar fuera
            document.addEventListener('click', closeAllTooltips);
            document.addEventListener('touchstart', closeAllTooltips);
            
            // AÃ±adir un mensaje inicial para nuevos jugadores
            const setupScreen = document.getElementById('screen-setup');
            const firstHelpBtn = setupScreen.querySelector('.help-btn');
            if (firstHelpBtn) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.innerHTML = `
                    <p style="margin-top: 10px; font-size: 0.9rem; color: var(--accent-color);">
                        Â¿Es tu primera vez? Presiona el botÃ³n <span style="border: 1px solid var(--accent-color); border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center;">?</span> en cada secciÃ³n para obtener ayuda.
                    </p>
                `;
                setupScreen.insertBefore(welcomeMsg, setupScreen.querySelector('.input-group'));
            }
            
            // Detectar si es iOS para ajustes especÃ­ficos
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                document.body.classList.add('ios-device');
                console.log("Dispositivo iOS detectado - Tooltips optimizados");
            }
        });
    </script>
</body>
</html>